<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDV</title>
    <link rel="icon" href="keti.png">
    <script src="js/eventemitter2.min.js"></script>
    <script src="js/easeljs.min.js"></script>
    <script src="js/roslib.min.js"></script>
    <script src="js/ros2d.min.js"></script>
    <script src="js/nipplejs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { overflow: hidden; position: fixed; width: 100%; height: 100%; font-family: -apple-system, sans-serif; background: #f2f2f7; }
        .app { height: 100%; display: flex; flex-direction: column; }

        /* Header */
        .header { display: flex; align-items: center; padding: 8px 12px; background: #fff; border-bottom: 1px solid #d1d1d6; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 6px; }
        .logo img { height: 20px; }
        .logo span { font-size: 15px; font-weight: 600; color: #1c1c1e; }
        .tabs { flex: 1; display: flex; justify-content: center; gap: 4px; }
        .tab { padding: 6px 20px; background: #e5e5ea; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; color: #3a3a3c; cursor: pointer; }
        .tab.active { background: #007aff; color: #fff; }
        .status { font-size: 11px; color: #8e8e93; display: flex; align-items: center; gap: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ff3b30; }
        .dot.on { background: #34c759; }

        /* Content */
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .page { display: none; flex-direction: column; height: 100%; }
        .page.active { display: flex; }

        /* Camera 16:9 */
        .camera-wrap { width: 100%; background: #000; position: relative; flex-shrink: 0; }
        .camera-wrap::before { content: ''; display: block; padding-top: 56.25%; }
        .camera-wrap img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }

        /* Map */
        .map-wrap { flex: 1; background: #1c1c1e; position: relative; min-height: 150px; overflow: hidden; }
        #mapDiv { width: 100%; height: 100%; }
        .map-btns { position: absolute; top: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 6px; z-index: 10; }
        .mbtn { padding: 8px 14px; background: #fff; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; color: #1c1c1e; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; }
        .mbtn:active { transform: scale(0.95); }
        .mbtn.on { background: #007aff; color: #fff; }
        .mbtn.red { background: #ff3b30; color: #fff; }
        .mstat { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 6px 10px; border-radius: 6px; font-size: 11px; color: #fff; font-weight: 500; }

        /* Control Row - LiDAR and Joystick only */
        .ctrl-row { display: flex; flex: 1; background: #fff; border-top: 1px solid #d1d1d6; min-height: 180px; }

        /* LiDAR */
        .lidar-box { flex: 1; background: #000; position: relative; }
        .lidar-box canvas { display: block; width: 100%; height: 100%; }

        /* Joystick */
        .joy-box { flex: 1; background: #f2f2f7; position: relative; }
        .joy-zone { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; background: radial-gradient(circle, #fff 0%, #e5e5ea 100%); border-radius: 50%; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }

        /* Bottom bar - odom + speed */
        .bottom-bar { display: flex; align-items: center; padding: 6px 12px; background: #fff; border-top: 1px solid #e5e5ea; flex-shrink: 0; gap: 12px; }
        .odom-group { display: flex; gap: 8px; }
        .odom-item { display: flex; align-items: center; gap: 2px; }
        .olbl { font-size: 10px; color: #8e8e93; font-weight: 600; }
        .oval { font-size: 13px; font-weight: 700; color: #1c1c1e; min-width: 45px; }
        .speed-group { flex: 1; display: flex; align-items: center; gap: 8px; }
        .speed-group label { font-size: 10px; font-weight: 600; color: #8e8e93; }
        .speed-group input { flex: 1; height: 4px; -webkit-appearance: none; background: #e5e5ea; border-radius: 2px; }
        .speed-group input::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #007aff; border-radius: 50%; }
        .speed-group span { font-size: 12px; font-weight: 700; color: #007aff; min-width: 36px; text-align: right; }

        /* AI overlay */
        .ai-btn { position: absolute; top: 8px; right: 8px; padding: 8px 16px; background: rgba(255,255,255,0.9); border: none; border-radius: 8px; font-size: 12px; font-weight: 600; z-index: 5; cursor: pointer; }
        .ai-btn:active { transform: scale(0.95); }
        .ai-btn.on { background: #34c759; color: #fff; }
        .log-bar { background: #1c1c1e; color: #34c759; font-family: monospace; font-size: 11px; padding: 6px 12px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <div class="logo"><img src="keti.png" alt=""><span>SDV</span></div>
        <nav class="tabs">
            <button class="tab active" data-page="control">Control</button>
            <button class="tab" data-page="map">Map</button>
            <button class="tab" data-page="ai">AI</button>
        </nav>
        <div class="status"><span class="dot" id="dot"></span><span id="stxt">Offline</span></div>
    </header>

    <div class="content">
        <!-- Control -->
        <div class="page active" id="page-control">
            <div class="camera-wrap"><img id="cam1" src="" alt=""></div>
            <div class="ctrl-row">
                <div class="lidar-box"><canvas id="lid1"></canvas></div>
                <div class="joy-box"><div class="joy-zone" id="jz1"></div></div>
            </div>
            <div class="bottom-bar">
                <div class="odom-group">
                    <div class="odom-item"><span class="olbl">X</span><span class="oval" id="x1">0.00</span></div>
                    <div class="odom-item"><span class="olbl">Y</span><span class="oval" id="y1">0.00</span></div>
                    <div class="odom-item"><span class="olbl">θ</span><span class="oval" id="t1">0°</span></div>
                </div>
                <div class="speed-group">
                    <label>Speed</label>
                    <input type="range" id="spd" min="10" max="150" value="50">
                    <span id="spdv">50%</span>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="page" id="page-map">
            <div class="map-wrap">
                <div id="mapDiv"></div>
                <div class="map-btns">
                    <button class="mbtn" id="bSlam">SLAM</button>
                    <button class="mbtn" id="bSave">Save</button>
                    <button class="mbtn" id="bLoad">Load</button>
                    <button class="mbtn" id="bNav">Nav</button>
                    <button class="mbtn red" id="bStop">Stop</button>
                </div>
                <div class="mstat" id="mstat">Ready</div>
            </div>
            <div class="ctrl-row">
                <div class="lidar-box"><canvas id="lid2"></canvas></div>
                <div class="joy-box"><div class="joy-zone" id="jz2"></div></div>
            </div>
            <div class="bottom-bar">
                <div class="odom-group">
                    <div class="odom-item"><span class="olbl">X</span><span class="oval" id="x2">0.00</span></div>
                    <div class="odom-item"><span class="olbl">Y</span><span class="oval" id="y2">0.00</span></div>
                    <div class="odom-item"><span class="olbl">θ</span><span class="oval" id="t2">0°</span></div>
                </div>
                <div class="speed-group">
                    <label>Speed</label>
                    <input type="range" id="spd2" min="10" max="150" value="50">
                    <span id="spdv2">50%</span>
                </div>
            </div>
        </div>

        <!-- AI -->
        <div class="page" id="page-ai">
            <div class="camera-wrap">
                <img id="cam2" src="" alt="">
                <button class="ai-btn" id="yoloB">YOLO</button>
            </div>
            <div class="ctrl-row">
                <div class="lidar-box"><canvas id="lid3"></canvas></div>
                <div class="joy-box"><div class="joy-zone" id="jz3"></div></div>
            </div>
            <div class="log-bar" id="logB">AI Detection Log</div>
            <div class="bottom-bar">
                <div class="odom-group">
                    <div class="odom-item"><span class="olbl">X</span><span class="oval" id="x3">0.00</span></div>
                    <div class="odom-item"><span class="olbl">Y</span><span class="oval" id="y3">0.00</span></div>
                    <div class="odom-item"><span class="olbl">θ</span><span class="oval" id="t3">0°</span></div>
                </div>
                <div class="speed-group">
                    <label>Speed</label>
                    <input type="range" id="spd3" min="10" max="150" value="50">
                    <span id="spdv3">50%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

let ros, cmdVel, aiPub, conn = false, spd = 0.5, pts = [], yolo = false;
const ML = 0.5, MA = 2.0;
const lids = ['lid1','lid2','lid3'].map(id => document.getElementById(id));

function initLids() {
    lids.forEach(c => { if(c?.parentElement) { c.width = c.parentElement.clientWidth; c.height = c.parentElement.clientHeight; } });
    drawLids();
}
window.onresize = initLids;
setTimeout(initLids, 100);

function setCam() {
    const s = `http://${location.hostname||'localhost'}:8080/stream`;
    document.getElementById('cam1').src = s;
    document.getElementById('cam2').src = s;
}

// Tabs
document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('page-'+t.dataset.page).classList.add('active');
        setTimeout(() => { initLids(); initJoys(); initMap(); }, 50);
    };
});

// Speed - sync all sliders
['spd','spd2','spd3'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.oninput = e => {
        spd = e.target.value/100;
        ['spd','spd2','spd3'].forEach(sid => { const s=document.getElementById(sid); if(s) s.value=e.target.value; });
        ['spdv','spdv2','spdv3'].forEach(vid => { const v=document.getElementById(vid); if(v) v.textContent=e.target.value+'%'; });
    };
});

// YOLO
document.getElementById('yoloB').onclick = function() {
    yolo = !yolo;
    this.classList.toggle('on', yolo);
    this.textContent = yolo ? 'YOLO ON' : 'YOLO';
    if(aiPub) aiPub.publish(new ROSLIB.Message({data: yolo?'yolo':'off'}));
    document.getElementById('logB').textContent = yolo ? 'Starting...' : 'Stopped';
};

// Map
let slam=false, nav=false;
document.getElementById('bSlam').onclick = function() { slam=!slam; nav=false; this.classList.toggle('on',slam); document.getElementById('bNav').classList.remove('on'); document.getElementById('mstat').textContent=slam?'SLAM':'Ready'; };
document.getElementById('bNav').onclick = function() { nav=!nav; slam=false; this.classList.toggle('on',nav); document.getElementById('bSlam').classList.remove('on'); document.getElementById('mstat').textContent=nav?'Nav':'Ready'; };
document.getElementById('bStop').onclick = () => { slam=nav=false; document.getElementById('bSlam').classList.remove('on'); document.getElementById('bNav').classList.remove('on'); document.getElementById('mstat').textContent='Ready'; stop(); };
document.getElementById('bSave').onclick = () => alert('Save');
document.getElementById('bLoad').onclick = () => alert('Load');

// ROS
function connect() {
    ros = new ROSLIB.Ros({url:`ws://${location.hostname||'localhost'}:9090`});
    ros.on('connection', () => { conn=true; document.getElementById('dot').classList.add('on'); document.getElementById('stxt').textContent='Online'; setup(); setCam(); initMap(); });
    ros.on('close', () => { conn=false; document.getElementById('dot').classList.remove('on'); document.getElementById('stxt').textContent='Offline'; setTimeout(connect,2000); });
}
function setup() {
    cmdVel = new ROSLIB.Topic({ros, name:'/cmd_vel', messageType:'geometry_msgs/Twist'});
    aiPub = new ROSLIB.Topic({ros, name:'/robot/ai_mode', messageType:'std_msgs/String'});
    new ROSLIB.Topic({ros, name:'/scan', messageType:'sensor_msgs/LaserScan', throttle_rate:150}).subscribe(onScan);
    new ROSLIB.Topic({ros, name:'/odom', messageType:'nav_msgs/Odometry'}).subscribe(onOdom);
    new ROSLIB.Topic({ros, name:'/detections', messageType:'std_msgs/String'}).subscribe(onDet);
}
function initMap() {
    if(!ros||!conn) return;
    const d = document.getElementById('mapDiv');
    if(!d||!d.offsetWidth) return;
    d.innerHTML = '';
    const v = new ROS2D.Viewer({divID:'mapDiv', width:d.offsetWidth, height:d.offsetHeight});
    const g = new ROS2D.OccupancyGridClient({ros, rootObject:v.scene, continuous:true});
    g.on('change', () => v.scaleToDimensions(g.currentGrid.width, g.currentGrid.height));
}

// LiDAR
let ld = 0;
function onScan(m) {
    pts = [];
    for(let i=0; i<m.ranges.length; i+=4) {
        const r = m.ranges[i];
        if(r>m.range_min && r<Math.min(m.range_max,5)) {
            const a = m.angle_min + i*m.angle_increment;
            pts.push({x:r*Math.cos(a-Math.PI/2), y:r*Math.sin(a-Math.PI/2), d:r});
        }
    }
    if(Date.now()-ld>100) { ld=Date.now(); drawLids(); }
}
function dc(d) { return d<0.5?'#ff3b30':d<1?'#ff9500':d<2?'#ffcc00':'#34c759'; }
function drawLids() {
    lids.forEach(c => {
        if(!c||!c.width) return;
        const ctx=c.getContext('2d'), cx=c.width/2, cy=c.height/2, sc=Math.min(c.width,c.height)/8;
        ctx.fillStyle='#000'; ctx.fillRect(0,0,c.width,c.height);
        ctx.strokeStyle='#333';
        [1,2,3].forEach(r => { ctx.beginPath(); ctx.arc(cx,cy,r*sc,0,Math.PI*2); ctx.stroke(); });
        pts.forEach(p => { ctx.fillStyle=dc(p.d); ctx.beginPath(); ctx.arc(cx+p.x*sc,cy+p.y*sc,2,0,Math.PI*2); ctx.fill(); });
        ctx.fillStyle='#007aff'; ctx.beginPath(); ctx.arc(cx,cy,4,0,Math.PI*2); ctx.fill();
    });
}

// Odom
function onOdom(m) {
    const x=m.pose.pose.position.x.toFixed(2), y=m.pose.pose.position.y.toFixed(2);
    const q=m.pose.pose.orientation, t=Math.round(Math.atan2(2*(q.w*q.z),1-2*q.z*q.z)*180/Math.PI);
    ['1','2','3'].forEach(i => {
        const ex=document.getElementById('x'+i), ey=document.getElementById('y'+i), et=document.getElementById('t'+i);
        if(ex) ex.textContent=x; if(ey) ey.textContent=y; if(et) et.textContent=t+'°';
    });
}

// Det
function onDet(m) {
    if(!yolo) return;
    try {
        const d = JSON.parse(m.data);
        document.getElementById('logB').innerHTML = d.slice(0,4).map(x=>`<span style="color:#ff9500">${x.class}</span> ${(x.confidence*100).toFixed(0)}%`).join('<br>');
    } catch(e){}
}

// Joysticks
let joys = {};
function mkJoy(id) {
    const z = document.getElementById(id);
    if(!z) return null;
    return nipplejs.create({
        zone: z,
        mode: 'static',
        position: {left:'50%', top:'50%'},
        color: '#8e8e93',
        size: 120
    }).on('move', (e,d) => {
        const f=Math.min(d.force,2)/2, a=d.angle.radian;
        send(Math.sin(a)*f*ML*spd*2, -Math.cos(a)*f*MA*spd*2);
    }).on('end', stop);
}
function initJoys() {
    Object.values(joys).forEach(j => j?.destroy());
    joys = { j1:mkJoy('jz1'), j2:mkJoy('jz2'), j3:mkJoy('jz3') };
}

// Vel
let tL=0,tA=0,cL=0,cA=0,lp=null;
function send(l,a) { tL=l; tA=a; if(!lp) lp=setInterval(pub,20); }
function pub() {
    if(!cmdVel||!conn) return;
    cL+=(tL-cL)*0.15; cA+=(tA-cA)*0.15;
    if(Math.abs(cL)<0.005) cL=0; if(Math.abs(cA)<0.005) cA=0;
    cmdVel.publish(new ROSLIB.Message({linear:{x:cL,y:0,z:0},angular:{x:0,y:0,z:cA}}));
    if(!tL&&!tA&&!cL&&!cA) { clearInterval(lp); lp=null; }
}
function stop() { tL=tA=0; }

// Key
document.onkeydown = e => {
    const s=spd*2;
    if(e.key==='w') send(ML*s,0);
    else if(e.key==='s') send(-ML*s,0);
    else if(e.key==='a') send(0,MA*s);
    else if(e.key==='d') send(0,-MA*s);
    else if(e.key===' ') stop();
};
document.onkeyup = e => { if('wasd'.includes(e.key)) stop(); };

setCam(); connect(); setTimeout(initJoys, 200);
</script>
</body>
</html>
